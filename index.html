<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BANËA PRO</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #ff385c; --bg: #000; --card: #1c1c1e; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; }

        /* LOGIN SCREEN */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { background: #111; padding: 30px; border-radius: 30px; width: 100%; max-width: 320px; text-align: center; border: 1px solid #222; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 1px solid #333; background: #1a1a1a; color: #fff; box-sizing: border-box; }
        
        /* GRILLE PRINCIPALE SYMETRIQUE */
        .header { text-align: center; padding: 25px; font-weight: 800; font-size: 26px; color: var(--primary); letter-spacing: 1px; }
        #userGrid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; 
            padding: 15px; 
            max-width: 900px; 
            margin: 0 auto; 
            min-height: 200px; /* Force l'affichage */
        }
        
        .user-card { 
            background: var(--card); 
            border-radius: 20px; 
            overflow: hidden; 
            position: relative; 
            aspect-ratio: 1; 
            border: 1px solid #333; 
            cursor: pointer;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .user-card img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px; background: linear-gradient(transparent, rgba(0,0,0,0.9)); text-align: center; }
        
        /* NOTIF FLASH */
        #notif { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: var(--primary); padding: 12px 25px; border-radius: 50px; z-index: 10000; transition: 0.5s; font-weight: bold; box-shadow: 0 5px 20px rgba(255, 56, 92, 0.4); }

        /* CHAT DRAWER */
        #chat-drawer { position: fixed; bottom: -100%; left: 0; right: 0; height: 85vh; background: #121212; z-index: 9000; border-radius: 25px 25px 0 0; transition: 0.4s ease; display: flex; flex-direction: column; }
        #chat-drawer.open { bottom: 0; }
        #msg-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { max-width: 70%; padding: 12px; border-radius: 15px; font-size: 14px; }
        .bubble.me { align-self: flex-end; background: var(--primary); }
        .bubble.you { align-self: flex-start; background: #333; }
        .input-area { padding: 15px; display: flex; gap: 10px; background: #121212; padding-bottom: 30px; }
    </style>
</head>
<body>

    <div id="notif">Nouveau message !</div>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:var(--primary)">BANËA</h1>
            <input type="text" id="name" placeholder="Prénom">
            <input type="number" id="age" placeholder="Âge">
            <select id="sex"><option value="Homme">Homme</option><option value="Femme">Femme</option></select>
            <button onclick="connect()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer; margin-top:10px;">REJOINDRE</button>
        </div>
    </div>

    <div class="header">BANËA</div>
    <div id="userGrid">
        </div>

    <div id="chat-drawer">
        <div style="padding:15px; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center;">
            <b id="chat-name">Nom</b>
            <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:20px;">✕</button>
        </div>
        <div id="msg-list"></div>
        <div class="input-area">
            <input type="text" id="m-in" style="flex:1; background:#222; border:none; padding:12px; border-radius:10px; color:white;" placeholder="Message...">
            <button onclick="send()" style="background:none; border:none; color:var(--primary); font-weight:bold; font-size:18px;">➔</button>
        </div>
    </div>

    <script>
        let socket, peer, targetSid, logs = {};

        function connect() {
            const name = document.getElementById('name').value;
            const age = document.getElementById('age').value;
            if(!name || !age) return alert("Remplis tout !");

            document.getElementById('login-screen').style.display = 'none';
            socket = io();
            peer = new Peer();

            peer.on('open', id => {
                socket.emit('join-room', { 
                    username: name, 
                    age: age, 
                    gender: document.getElementById('sex').value, 
                    peerId: id 
                });
            });

            socket.on('update-users', users => {
                const grid = document.getElementById('userGrid');
                grid.innerHTML = ""; 
                
                users.forEach(u => {
                    if(u.id !== socket.id) {
                        const card = document.createElement('div');
                        card.className = "user-card";
                        card.onclick = () => openChat(u.id, u.name);
                        card.innerHTML = `
                            <img src="${u.avatar}">
                            <div class="user-info">
                                <b>${u.name}, ${u.age}</b>
                            </div>`;
                        grid.appendChild(card);
                    }
                });
            });

            socket.on('receive-private-message', data => {
                const partner = (data.fromId === socket.id) ? targetSid : data.fromId;
                if(!logs[partner]) logs[partner] = [];
                logs[partner].push(data);
                
                if(partner === targetSid) render();
                else flash();
            });
        }

        function flash() {
            const n = document.getElementById('notif');
            n.style.top = "20px";
            setTimeout(() => n.style.top = "-100px", 3000);
        }

        function openChat(sid, name) {
            targetSid = sid;
            document.getElementById('chat-name').innerText = name;
            document.getElementById('chat-drawer').classList.add('open');
            render();
        }

        function closeChat() { document.getElementById('chat-drawer').classList.remove('open'); targetSid = null; }

        function render() {
            const box = document.getElementById('msg-list');
            box.innerHTML = "";
            (logs[targetSid] || []).forEach(m => {
                const d = document.createElement('div');
                d.className = `bubble ${m.fromId === socket.id ? 'me' : 'you'}`;
                d.innerText = m.text;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        }

        function send() {
            const val = document.getElementById('m-in').value;
            if(!val) return;
            socket.emit('send-private-message', { toSocketId: targetSid, text: val });
            document.getElementById('m-in').value = "";
        }
    </script>
</body>
</html>
