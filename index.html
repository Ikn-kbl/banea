<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANÃ‹A PRO</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #ff3b5c; --bg: #0a0a0a; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }
        
        /* LOGIN */
        #auth { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-start { background: var(--accent); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 18px; }

        /* VIDEO GRID - STYLE AZAR */
        #video-grid { display: grid; grid-template-columns: 1fr; grid-template-rows: 1fr; height: 100vh; width: 100vw; }
        #video-grid.dual { grid-template-rows: 1fr 1fr; } /* Un au dessus de l'autre sur mobile */
        
        video { width: 100%; height: 100%; object-fit: cover; background: #222; }
        #local-video { transform: scaleX(-1); border-bottom: 2px solid var(--accent); }

        /* UI OVERLAY */
        .controls { position: absolute; bottom: 30px; left: 0; right: 0; display: flex; justify-content: center; gap: 20px; z-index: 10; }
        .icon-btn { width: 60px; height: 60px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; font-size: 20px; cursor: pointer; }
        .btn-next { width: 120px; border-radius: 30px; background: var(--accent); }
    </style>
</head>
<body>

    <div id="auth">
        <h1 style="color:var(--accent)">BANÃ‹A</h1>
        <input type="text" id="nick" placeholder="Ton nom..." style="padding:15px; border-radius:15px; border:none; margin-bottom:20px; width:250px;">
        <button class="btn-start" onclick="start()">ENTRER</button>
    </div>

    <div id="video-grid">
        <video id="local-video" autoplay muted playsinline></video>
        </div>

    <div class="controls">
        <button class="icon-btn">ðŸŽ¤</button>
        <button class="icon-btn btn-next" onclick="location.reload()">SUIVANT</button>
        <button class="icon-btn">ðŸ’¬</button>
    </div>

    <script>
        let socket, peer, myStream;
        const grid = document.getElementById('video-grid');

        async function start() {
            const name = document.getElementById('nick').value;
            if(!name) return alert("Nom requis");

            // 1. Capture CamÃ©ra avec config PRO pour le son
            myStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: { echoCancellation: true, noiseSuppression: true }
            });
            document.getElementById('local-video').srcObject = myStream;
            document.getElementById('auth').style.display = 'none';

            // 2. Initialisation Signalisation
            socket = io();
            peer = new Peer();

            peer.on('open', id => {
                socket.emit('join', { name: name, peerId: id });
            });

            // 3. Quand quelqu'un nous appelle
            peer.on('call', call => {
                call.answer(myStream);
                handleCall(call);
            });

            // 4. Logique de matching
            socket.on('users', users => {
                const partner = users.find(u => u.peerId !== peer.id);
                if(partner && !document.getElementById('remote-video')) {
                    const call = peer.call(partner.peerId, myStream);
                    handleCall(call);
                }
            });
        }

        function handleCall(call) {
            call.on('stream', remoteStream => {
                if(document.getElementById('remote-video')) return;

                const rv = document.createElement('video');
                rv.id = 'remote-video';
                rv.autoplay = true;
                rv.playsInline = true;
                rv.srcObject = remoteStream;
                
                grid.classList.add('dual');
                grid.appendChild(rv);
            });
        }
    </script>
</body>
</html>
