<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BAN√ãA V110</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #ff385c; --accent: #00f2ff; --bg: #050505; --card: rgba(255, 255, 255, 0.08); }
        body { background: var(--bg); color: #fff; font-family: 'Poppins', sans-serif; margin: 0; overflow: hidden; height: 100vh; }

        /* √âCRAN DE CONNEXION AVEC UPLOAD PHOTO */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; overflow-y: auto; }
        .login-card { background: var(--card); backdrop-filter: blur(20px); padding: 30px; border-radius: 30px; width: 90%; max-width: 380px; text-align: center; }
        #photo-preview { width: 80px; height: 80px; border-radius: 50%; background: #222; margin: 10px auto; object-fit: cover; border: 2px solid var(--primary); display: none; }
        
        /* INTERFACE PRINCIPALE */
        #main-app { display: none; height: 100vh; flex-direction: column; }
        #userList { display: flex; gap: 15px; padding: 15px; overflow-x: auto; border-bottom: 1px solid #222; }
        .u-card { min-width: 100px; text-align: center; position: relative; cursor: pointer; }
        .u-card img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid transparent; }
        .u-card.active img { border-color: var(--accent); }
        
        /* CHAT & CONSENTEMENT */
        #chat-window { flex: 1; display: flex; flex-direction: column; position: relative; }
        #consent-overlay { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 10; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        /* BULLES M√âDIAS */
        .msg img { max-width: 200px; border-radius: 10px; margin-top: 5px; }
        .msg audio { max-width: 200px; height: 30px; }
        
        /* ACTIONS */
        .user-actions { padding: 10px; display: flex; justify-content: space-around; background: rgba(255,255,255,0.03); }
        .btn-action { background: none; border: none; font-size: 18px; cursor: pointer; color: #fff; }

        .footer { padding: 15px; display: flex; gap: 10px; background: #111; align-items: center; }
        input[type="text"] { flex: 1; background: #222; border: none; padding: 12px; border-radius: 20px; color: #fff; }
        .btn-media { background: #333; border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="color:var(--primary)">BAN√ãA</h2>
            <img id="photo-preview" src="">
            <input type="file" id="photo-input" accept="image/*" style="display:none">
            <button onclick="document.getElementById('photo-input').click()" style="font-size:12px; margin-bottom:10px; background:none; color:var(--accent); border:none; cursor:pointer;">+ Ajouter une photo</button>
            
            <input type="text" id="p-name" placeholder="Pseudo">
            <input type="number" id="p-age" placeholder="√Çge">
            <select id="p-gender">
                <option value="Homme">Homme</option>
                <option value="Femme">Femme</option>
            </select>
            <button class="btn-media" style="width:100%; border-radius:10px; background:var(--primary)" onclick="join()">REJOINDRE</button>
        </div>
    </div>

    <div id="main-app">
        <div id="userList"></div>
        
        <div class="user-actions" id="actions-bar" style="display:none">
            <button class="btn-action" onclick="like()">‚ù§Ô∏è</button>
            <button class="btn-action" id="callBtn" onclick="startCall()">üìû Video</button>
            <button class="btn-action" style="color:#ef4444" onclick="block()">üö´ Bloquer</button>
        </div>

        <div id="chat-window">
            <div id="consent-overlay">
                <p id="consent-text"></p>
                <button onclick="acceptRequest()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:10px;">Accepter la discussion</button>
            </div>
            <div id="messages"></div>
            <div class="footer">
                <button class="btn-media" onclick="document.getElementById('file-msg').click()">üì∑</button>
                <input type="file" id="file-msg" accept="image/*" style="display:none" onchange="sendImage(this)">
                <input type="text" id="msgInput" placeholder="Message...">
                <button class="btn-media" id="voice-btn" onmousedown="startVoice()" onmouseup="stopVoice()">üéôÔ∏è</button>
                <button class="btn-media" onclick="sendText()">‚ûî</button>
            </div>
        </div>
    </div>

    <div id="video-screen" style="display:none; position:fixed; inset:0; background:#000; z-index:4000;">
        <video id="remote-video" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
        <button onclick="endCall()" style="position:absolute; bottom:40px; left:50%; transform:translateX(-50%); background:red; border:none; width:70px; height:70px; border-radius:50%; color:white; font-size:30px;">üìµ</button>
    </div>

    <script>
        let socket, peer, myStream, myName, targetSid, targetPid, myPhoto = null;
        let chatHistories = {};
        let acceptedChats = [];
        let mediaRecorder, audioChunks = [];

        // Pr√©visualisation Photo
        document.getElementById('photo-input').onchange = e => {
            const reader = new FileReader();
            reader.onload = () => {
                myPhoto = reader.result;
                document.getElementById('photo-preview').src = myPhoto;
                document.getElementById('photo-preview').style.display = 'block';
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        function join() {
            const name = document.getElementById('p-name').value;
            if(!name) return;
            myName = name;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';

            socket = io();
            peer = new Peer();

            peer.on('open', id => {
                socket.emit('join-room', { 
                    username: name, 
                    age: document.getElementById('p-age').value, 
                    gender: document.getElementById('p-gender').value,
                    photo: myPhoto,
                    peerId: id 
                });
            });

            socket.on('update-users', users => {
                const list = document.getElementById('userList');
                list.innerHTML = "";
                users.forEach(u => {
                    if(u.id !== socket.id) {
                        const card = document.createElement('div');
                        card.className = "u-card";
                        card.innerHTML = `<img src="${u.avatar}"><div>${u.name}</div>`;
                        card.onclick = () => selectUser(u.id, u.peerId, u.name);
                        list.appendChild(card);
                    }
                });
            });

            socket.on('receive-private-message', data => {
                const partnerId = data.fromId === socket.id ? targetSid : data.fromId;
                if(!chatHistories[partnerId]) chatHistories[partnerId] = [];
                chatHistories[partnerId].push(data);

                if(partnerId === targetSid) {
                    // Si on re√ßoit un message d'un nouveau et qu'on n'a pas accept√©
                    if(data.fromId !== socket.id && !acceptedChats.includes(partnerId)) {
                        document.getElementById('consent-overlay').style.display = 'flex';
                        document.getElementById('consent-text').innerText = data.sender + " souhaite vous parler.";
                    }
                    renderMessages();
                }
            });

            socket.on('chat-accepted', data => {
                acceptedChats.push(data.by);
                alert("Discussion accept√©e !");
            });
        }

        function selectUser(sid, pid, name) {
            targetSid = sid; targetPid = pid;
            document.getElementById('actions-bar').style.display = 'flex';
            document.getElementById('consent-overlay').style.display = acceptedChats.includes(sid) ? 'none' : 'none'; 
            renderMessages();
        }

        function acceptRequest() {
            acceptedChats.push(targetSid);
            socket.emit('accept-chat', { fromId: targetSid });
            document.getElementById('consent-overlay').style.display = 'none';
        }

        function renderMessages() {
            const box = document.getElementById('messages');
            box.innerHTML = "";
            (chatHistories[targetSid] || []).forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.fromId === socket.id ? 'me' : 'you'}`;
                if(m.type === 'image') div.innerHTML = `<img src="${m.text}">`;
                else if(m.type === 'voice') div.innerHTML = `<audio src="${m.text}" controls></audio>`;
                else div.innerText = m.text;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        }

        function sendText() {
            const txt = document.getElementById('msgInput').value;
            if(!txt) return;
            socket.emit('send-private-message', { toSocketId: targetSid, text: txt, type: 'text' });
            document.getElementById('msgInput').value = "";
        }

        function sendImage(input) {
            const reader = new FileReader();
            reader.onload = () => {
                socket.emit('send-private-message', { toSocketId: targetSid, text: reader.result, type: 'image' });
            };
            reader.readAsDataURL(input.files[0]);
        }

        // Logic Bloquer
        function block() {
            if(confirm("Bloquer cet utilisateur ?")) {
                socket.emit('block-user', { targetId: targetSid });
                location.reload();
            }
        }

        // Logic Appel
        async function startCall() {
            if(!acceptedChats.includes(targetSid)) return alert("L'utilisateur doit accepter la discussion d'abord.");
            myStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('video-screen').style.display = 'block';
            peer.call(targetPid, myStream).on('stream', rs => {
                document.getElementById('remote-video').srcObject = rs;
            });
        }

        function endCall() {
            socket.emit('end-call', { toSocketId: targetSid });
            location.reload();
        }
    </script>
</body>
</html>
