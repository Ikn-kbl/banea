<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BANÃ‹A PREMIUM</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --main: #ff385c; --glass: rgba(255, 255, 255, 0.1); --bg: #0a0a0b; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, system-ui, sans-serif; margin: 0; overflow-x: hidden; }

        /* NOTIFICATION PRO */
        #push-notif { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 380px; background: #1c1c1e; border: 1px solid #333; padding: 12px; border-radius: 18px; z-index: 10000; display: flex; align-items: center; gap: 12px; transition: 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28); box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        #push-notif.active { top: 20px; }

        /* GRID SYSTEM */
        .app-container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .user-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 20px; }
        .user-card { background: #161618; border-radius: 24px; overflow: hidden; position: relative; aspect-ratio: 3/4; border: 1px solid #222; cursor: pointer; transition: 0.3s; }
        .user-card:hover { border-color: var(--main); transform: translateY(-5px); }
        .user-card img { width: 100%; height: 100%; object-fit: cover; }
        .card-label { position: absolute; bottom: 0; width: 100%; padding: 15px; background: linear-gradient(transparent, #000); box-sizing: border-box; }

        /* CHAT WINDOW SLIM */
        #chat-window { position: fixed; bottom: -100%; left: 0; right: 0; height: 90vh; background: #0f0f11; z-index: 9000; transition: 0.4s ease; border-radius: 25px 25px 0 0; display: flex; flex-direction: column; max-width: 500px; margin: 0 auto; box-shadow: 0 -10px 50px rgba(0,0,0,0.5); }
        #chat-window.open { bottom: 0; }
        #msg-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .bubble { max-width: 80%; padding: 12px 16px; border-radius: 20px; font-size: 15px; position: relative; }
        .bubble.me { align-self: flex-end; background: var(--main); border-bottom-right-radius: 4px; }
        .bubble.you { align-self: flex-start; background: #2c2c2e; border-bottom-left-radius: 4px; }

        /* VIDEO CALL FULLSCREEN */
        #video-overlay { display: none; position: fixed; inset: 0; background: #000; z-index: 9999; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; top: 30px; right: 20px; width: 110px; height: 170px; border-radius: 20px; border: 2px solid #fff; object-fit: cover; }
        .call-controls { position: absolute; bottom: 50px; left: 0; right: 0; display: flex; justify-content: center; gap: 25px; }
        .ctrl-btn { width: 65px; height: 65px; border-radius: 50%; border: none; font-size: 24px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-red { background: #ff3b30; }
        .btn-gray { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); }

        /* UI BUTTONS */
        .btn-main { background: var(--main); border: none; padding: 15px; border-radius: 14px; color: #fff; font-weight: bold; cursor: pointer; width: 100%; }
        .input-pill { background: #1c1c1e; border: 1px solid #333; padding: 14px; border-radius: 25px; color: #fff; flex: 1; outline: none; }
    </style>
</head>
<body>

    <div id="push-notif">
        <img id="push-avatar" style="width:40px; height:40px; border-radius:50%;">
        <div>
            <div id="push-name" style="font-weight:bold; font-size:14px;"></div>
            <div id="push-text" style="font-size:13px; opacity:0.7;"></div>
        </div>
    </div>

    <div id="login-screen" style="position:fixed; inset:0; background:#000; z-index:10001; display:flex; align-items:center; justify-content:center;">
        <div style="width:320px; text-align:center;">
            <h1 style="color:var(--main); font-size:40px; margin:0;">BANÃ‹A</h1>
            <p style="opacity:0.5; margin-bottom:30px;">Premium Chat & Video</p>
            <input type="text" id="in-name" class="input-pill" style="margin-bottom:10px; width:100%;" placeholder="Ton pseudo">
            <input type="number" id="in-age" class="input-pill" style="margin-bottom:20px; width:100%;" placeholder="Ã‚ge">
            <button onclick="initApp()" class="btn-main">ENTRER</button>
        </div>
    </div>

    <div class="app-container">
        <h2 style="font-size:28px; margin-bottom:25px;">Personnes en ligne</h2>
        <div id="userGrid" class="user-grid"></div>
    </div>

    <div id="chat-window">
        <div style="padding:20px; border-bottom:1px solid #222; display:flex; align-items:center; justify-content:space-between;">
            <b id="target-title">Nom</b>
            <div style="display:flex; gap:15px;">
                <button onclick="startCall()" style="background:none; border:none; font-size:22px; cursor:pointer;">ðŸŽ¥</button>
                <button onclick="document.getElementById('chat-window').classList.remove('open')" style="background:none; border:none; color:#fff; font-size:20px;">âœ•</button>
            </div>
        </div>
        <div id="msg-box"></div>
        <div style="padding:20px; display:flex; gap:10px; padding-bottom:35px;">
            <input type="text" id="m-input" class="input-pill" placeholder="Votre message...">
            <button onclick="sendMessage()" class="btn-main" style="width:auto; padding:0 25px;">âž”</button>
        </div>
    </div>

    <div id="video-overlay">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="call-controls">
            <button class="ctrl-btn btn-gray" onclick="toggleMic()">ðŸŽ¤</button>
            <button class="ctrl-btn btn-red" onclick="endCall()">ðŸ“µ</button>
            <button class="ctrl-btn btn-gray" onclick="toggleCam()">ðŸ“·</button>
        </div>
    </div>

    <script>
        let socket, peer, localStream, currentCall, targetSid, targetPid, logs = {};

        async function initApp() {
            const n = document.getElementById('in-name').value;
            const a = document.getElementById('in-age').value;
            if(!n || !a) return;

            document.getElementById('login-screen').style.display = 'none';
            socket = io();
            peer = new Peer();

            peer.on('open', id => {
                socket.emit('join-room', { username: n, age: a, peerId: id });
            });

            socket.on('update-users', users => {
                const grid = document.getElementById('userGrid');
                grid.innerHTML = "";
                users.forEach(u => {
                    if(u.id !== socket.id) {
                        const card = document.createElement('div');
                        card.className = "user-card";
                        card.onclick = () => openChat(u.id, u.peerId, u.name, u.avatar);
                        card.innerHTML = `<img src="${u.avatar}"><div class="card-label"><b>${u.name}, ${u.age}</b></div>`;
                        grid.appendChild(card);
                    }
                });
            });

            socket.on('receive-private-message', data => {
                const partner = (data.fromId === socket.id) ? targetSid : data.fromId;
                if(!logs[partner]) logs[partner] = [];
                logs[partner].push(data);
                
                if(partner === targetSid) renderMessages();
                else showPushNotif(data);
            });

            peer.on('call', async call => {
                if(confirm("Appel vidÃ©o entrant de " + call.peer)) {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "user", aspectRatio: 9/16 }, 
                        audio: { echoCancellation: true, noiseSuppression: true }
                    });
                    document.getElementById('video-overlay').style.display = 'block';
                    document.getElementById('local-video').srcObject = localStream;
                    call.answer(localStream);
                    currentCall = call;
                    call.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
                }
            });
        }

        function showPushNotif(data) {
            const n = document.getElementById('push-notif');
            document.getElementById('push-name').innerText = data.sender;
            document.getElementById('push-text').innerText = data.text;
            n.classList.add('active');
            setTimeout(() => n.classList.remove('active'), 4000);
        }

        function openChat(sid, pid, name, avatar) {
            targetSid = sid; targetPid = pid;
            document.getElementById('target-title').innerText = name;
            document.getElementById('chat-window').classList.add('open');
            renderMessages();
        }

        function renderMessages() {
            const box = document.getElementById('msg-box');
            box.innerHTML = "";
            (logs[targetSid] || []).forEach(m => {
                const d = document.createElement('div');
                d.className = `bubble ${m.fromId === socket.id ? 'me' : 'you'}`;
                d.innerText = m.text;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        }

        function sendMessage() {
            const v = document.getElementById('m-input').value;
            if(!v) return;
            socket.emit('send-private-message', { toSocketId: targetSid, text: v });
            document.getElementById('m-input').value = "";
        }

        async function startCall() {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "user", aspectRatio: 9/16 },
                audio: { echoCancellation: true, noiseSuppression: true }
            });
            document.getElementById('video-overlay').style.display = 'block';
            document.getElementById('local-video').srcObject = localStream;
            currentCall = peer.call(targetPid, localStream);
            currentCall.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
        }

        function endCall() {
            if(currentCall) currentCall.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('video-overlay').style.display = 'none';
        }

        function toggleMic() {
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
        }

        function toggleCam() {
            const videoTrack = localStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
        }
    </script>
</body>
</html>
