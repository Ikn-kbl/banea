<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANEA ULTIMATE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background: #000; color: #00d2ff; font-family: sans-serif; text-align: center; margin: 0; padding: 10px; }
        .box { border: 2px solid #00d2ff; padding: 15px; border-radius: 10px; margin-top: 10px; }
        video { width: 45%; background: #222; border: 1px solid #00d2ff; border-radius: 10px; margin: 5px; height: 120px; object-fit: cover; }
        #chat { height: 200px; border: 1px solid #333; overflow-y: auto; background: #111; margin: 10px 0; padding: 10px; text-align: left; font-size: 14px; }
        input { padding: 10px; width: 60%; border-radius: 5px; border: none; }
        button { padding: 10px; background: #00d2ff; color: #000; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; }
        .user-row { display: flex; justify-content: space-between; background: #1a1a1a; padding: 8px; margin-top: 5px; border-radius: 5px; }
    </style>
</head>
<body>

    <h2>BANÃ‹A V10</h2>

    <div id="login-screen" class="box">
        <input type="text" id="pseudoInput" placeholder="Ton pseudo...">
        <button onclick="startApp()">ENTRER</button>
    </div>

    <div id="main-screen" style="display:none;">
        <div style="display:flex; justify-content: center;">
            <video id="localVid" autoplay muted playsinline></video>
            <video id="remoteVid" autoplay playsinline></video>
        </div>

        <div id="chat"></div>
        
        <input type="text" id="msgInput" placeholder="Ton message...">
        <button onclick="envoi()">ENVOYER</button>

        <div id="userList" class="box"></div>
        <button onclick="location.reload()" style="background:red; color:white; margin-top:20px;">QUITTER</button>
    </div>

    <script>
        let socket;
        let peer;
        let monStream;
        let monNom;

        // 1. DÃ‰MARRAGE
        function startApp() {
            monNom = document.getElementById('pseudoInput').value;
            if(!monNom) return alert("Mets un pseudo !");

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'block';

            // Initialisation Socket
            socket = io();

            // Initialisation VidÃ©o (PeerJS)
            peer = new Peer();

            // Demander la camÃ©ra
            navigator.mediaDevices.getUserMedia({video: true, audio: true})
                .then(stream => {
                    monStream = stream;
                    document.getElementById('localVid').srcObject = stream;
                    console.log("CamÃ©ra OK");
                })
                .catch(err => alert("Erreur CamÃ©ra : " + err));

            // Quand PeerJS nous donne notre ID spÃ©cial d'appel
            peer.on('open', (id) => {
                console.log("Mon ID Peer : " + id);
                socket.emit('join-room', { username: monNom, peerId: id });
            });

            // Recevoir un message
            socket.on('receive-message', (data) => {
                const chat = document.getElementById('chat');
                chat.innerHTML += `<div><b style="color:yellow">${data.user}:</b> ${data.text}</div>`;
                chat.scrollTop = chat.scrollHeight;
            });

            // Mettre Ã  jour la liste des gens et les boutons APPELER
            socket.on('update-users', (users) => {
                const list = document.getElementById('userList');
                list.innerHTML = "<b>ConnectÃ©s :</b>";
                users.forEach(u => {
                    if(u.id !== socket.id) {
                        list.innerHTML += `
                            <div class="user-row">
                                <span>ðŸ‘¤ ${u.name}</span>
                                <button onclick="faireAppel('${u.peerId}')">APPELER</button>
                            </div>`;
                    }
                });
            });

            // RÃ©pondre automatiquement Ã  un appel
            peer.on('call', (call) => {
                console.log("On reÃ§oit un appel...");
                call.answer(monStream);
                call.on('stream', (remoteStream) => {
                    document.getElementById('remoteVid').srcObject = remoteStream;
                });
            });
        }

        // 2. ENVOYER UN MESSAGE
        function envoi() {
            const input = document.getElementById('msgInput');
            if(!input.value) return;
            console.log("Envoi du message : " + input.value);
            socket.emit('send-message', { user: monNom, text: input.value });
            input.value = "";
        }

        // 3. PASSER UN APPEL
        function faireAppel(remotePeerId) {
            console.log("Appel de : " + remotePeerId);
            const call = peer.call(remotePeerId, monStream);
            call.on('stream', (remoteStream) => {
                document.getElementById('remoteVid').srcObject = remoteStream;
            });
        }
    </script>
</body>
</html>
