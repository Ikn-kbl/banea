<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BAN√ãA SOCIAL</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --main: #ff3b5c; --bg: #050505; --panel: rgba(28, 28, 30, 0.7); --border: rgba(255,255,255,0.1); }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; height: 100vh; }

        /* GLASSMORPHISM UI */
        .glass { backdrop-filter: blur(20px); background: var(--panel); border: 1px solid var(--border); }
        
        /* LAYOUT */
        .app-shell { display: flex; height: 100vh; width: 100vw; }
        
        /* SIDEBAR (LISTE D'AMIS) */
        .sidebar { width: 350px; border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: 0.3s; }
        .sidebar-header { padding: 25px; font-size: 24px; font-weight: 800; color: var(--main); }
        .user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 18px; cursor: pointer; transition: 0.2s; margin-bottom: 5px; }
        .user-item:hover { background: rgba(255,255,255,0.05); }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #222; }

        /* CHAT AREA */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: url('https://w0.peakpx.com/wallpaper/596/633/HD-wallpaper-whatsapp-dark-patterns-black-texture.jpg'); background-size: contain; }
        .chat-header { height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; }
        
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 65%; padding: 12px 16px; border-radius: 20px; font-size: 14px; position: relative; line-height: 1.4; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .msg.me { align-self: flex-end; background: var(--main); color: white; border-bottom-right-radius: 4px; }
        .msg.you { align-self: flex-start; background: #262629; color: white; border-bottom-left-radius: 4px; }
        .msg img { width: 100%; border-radius: 12px; margin-top: 5px; }
        .msg-time { font-size: 10px; opacity: 0.6; display: block; text-align: right; margin-top: 4px; }

        /* INPUT BAR */
        .input-bar { padding: 20px; display: flex; gap: 12px; align-items: center; background: rgba(10,10,11,0.9); }
        .input-pill { flex: 1; background: #1c1c1e; border: 1px solid #333; padding: 14px 20px; border-radius: 30px; color: #fff; outline: none; }
        
        /* LOGIN MODAL */
        #auth { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .auth-card { width: 320px; text-align: center; }

        /* VIDEO CALL */
        #video-view { display: none; position: fixed; inset: 0; background: #000; z-index: 9999; }
        #remote-v { width: 100%; height: 100%; object-fit: cover; }
        #local-v { position: absolute; top: 30px; right: 20px; width: 120px; height: 180px; border-radius: 20px; border: 2px solid #fff; object-fit: cover; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; z-index: 5; }
            .sidebar.hidden { transform: translateX(-100%); }
            .chat-area { width: 100%; }
        }
    </style>
</head>
<body>

    <div id="auth">
        <div class="auth-card">
            <h1 style="color:var(--main); font-size:42px; margin:0;">BAN√ãA</h1>
            <p style="opacity:0.5; margin-bottom:40px;">Social & Video Discovery</p>
            <input type="text" id="username" class="input-pill" style="width:100%; margin-bottom:15px;" placeholder="Ton pr√©nom">
            <button onclick="login()" style="width:100%; padding:15px; border-radius:30px; border:none; background:var(--main); color:white; font-weight:bold; cursor:pointer;">REJOINDRE</button>
        </div>
    </div>

    <div class="app-shell">
        <div class="sidebar glass" id="sidebar">
            <div class="sidebar-header">Messages</div>
            <div class="user-list" id="user-list">
                </div>
        </div>

        <div class="chat-area">
            <div class="chat-header glass">
                <div style="display:flex; align-items:center; gap:12px;">
                    <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:20px;" class="mobile-only">‚ò∞</button>
                    <b id="chat-title">Choisis une discussion</b>
                </div>
                <div id="call-btns" style="display:none; gap:15px;">
                    <button onclick="startCall()" style="background:none; border:none; font-size:20px;">üìû</button>
                    <button onclick="block()" style="background:none; border:none; font-size:20px;">üö´</button>
                </div>
            </div>

            <div id="messages"></div>

            <div class="input-bar glass">
                <button onclick="document.getElementById('img-in').click()" style="background:none; border:none; font-size:22px;">üñºÔ∏è</button>
                <input type="file" id="img-in" hidden accept="image/*" onchange="sendImage(this)">
                <input type="text" id="msg-input" class="input-pill" placeholder="√âcrire...">
                <button onclick="send()" style="background:none; border:none; color:var(--main); font-weight:bold; font-size:18px;">‚ûî</button>
            </div>
        </div>
    </div>

    <div id="video-view">
        <video id="remote-v" autoplay playsinline></video>
        <video id="local-v" autoplay muted playsinline></video>
        <button onclick="endCall()" style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%); background:red; border:none; padding:15px 30px; border-radius:30px; color:white; font-weight:bold;">RACCROCHER</button>
    </div>

    <script>
        let socket, peer, myUid, myStream, targetSid, targetPid, logs = {};

        // 1. GESTION DE L'HISTORIQUE (LocalStorage)
        function saveLog(uid, msg) {
            if(!logs[uid]) logs[uid] = [];
            logs[uid].push(msg);
            localStorage.setItem(`banea_logs_${myUid}`, JSON.stringify(logs));
        }

        function loadLogs() {
            const saved = localStorage.getItem(`banea_logs_${myUid}`);
            if(saved) logs = JSON.parse(saved);
        }

        // 2. INITIALISATION
        function login() {
            const name = document.getElementById('username').value;
            if(!name) return;
            
            myUid = 'user_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('auth').style.display = 'none';
            loadLogs();

            socket = io();
            peer = new Peer();

            peer.on('open', id => {
                socket.emit('join-room', { username: name, uid: myUid, peerId: id });
            });

            socket.on('update-users', users => {
                const list = document.getElementById('user-list');
                list.innerHTML = "";
                users.forEach(u => {
                    if(u.id !== socket.id) {
                        const div = document.createElement('div');
                        div.className = "user-item";
                        div.onclick = () => openChat(u);
                        div.innerHTML = `<img src="${u.avatar}" class="avatar"><div><b>${u.name}</b><br><small style="color:#30d158">En ligne</small></div>`;
                        list.appendChild(div);
                    }
                });
            });

            socket.on('receive-message', data => {
                const partner = (data.fromUid === myUid) ? targetSid : data.fromId; 
                saveLog(partner, data);
                if(targetSid === partner) render();
            });

            peer.on('call', async call => {
                if(confirm("Appel vid√©o entrant...")) {
                    myStream = await navigator.mediaDevices.getUserMedia({video:true, audio:{echoCancellation:true}});
                    document.getElementById('video-view').style.display = 'block';
                    document.getElementById('local-v').srcObject = myStream;
                    call.answer(myStream);
                    call.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
                }
            });
        }

        // 3. MESSAGERIE
        function openChat(user) {
            targetSid = user.id;
            targetPid = user.peerId;
            document.getElementById('chat-title').innerText = user.name;
            document.getElementById('call-btns').style.display = 'flex';
            if(window.innerWidth < 768) toggleSidebar();
            render();
        }

        function render() {
            const box = document.getElementById('messages');
            box.innerHTML = "";
            (logs[targetSid] || []).forEach(m => {
                const d = document.createElement('div');
                d.className = `msg ${m.fromUid === myUid ? 'me' : 'you'}`;
                d.innerHTML = m.type === 'image' ? `<img src="${m.text}">` : m.text;
                d.innerHTML += `<span class="msg-time">${m.time}</span>`;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        }

        function send() {
            const val = document.getElementById('msg-input').value;
            if(!val) return;
            socket.emit('send-message', { toSocketId: targetSid, fromUid: myUid, text: val, type: 'text' });
            document.getElementById('msg-input').value = "";
        }

        function sendImage(input) {
            const reader = new FileReader();
            reader.onload = () => {
                socket.emit('send-message', { toSocketId: targetSid, fromUid: myUid, text: reader.result, type: 'image' });
            };
            reader.readAsDataURL(input.files[0]);
        }

        // 4. VID√âO & FILTRES
        async function startCall() {
            myStream = await navigator.mediaDevices.getUserMedia({video:true, audio:{echoCancellation:true}});
            document.getElementById('video-view').style.display = 'block';
            document.getElementById('local-v').srcObject = myStream;
            const call = peer.call(targetPid, myStream);
            call.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
        }

        function endCall() {
            document.getElementById('video-view').style.display = 'none';
            if(myStream) myStream.getTracks().forEach(t => t.stop());
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden');
        }
    </script>
</body>
</html>
