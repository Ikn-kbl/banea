<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BAN√ãA V120</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #ff385c; --bg: #0a0a0a; --accent: #00f2ff; }
        body { background: var(--bg); color: white; font-family: 'Poppins', sans-serif; margin: 0; height: 100vh; overflow: hidden; }
        
        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: #1a1a1a; padding: 30px; border-radius: 30px; width: 320px; text-align: center; }

        /* HEADER & LIST */
        .app-container { display: none; height: 100vh; flex-direction: column; }
        #userList { display: flex; gap: 15px; padding: 20px; overflow-x: auto; background: #111; border-bottom: 1px solid #222; }
        .u-card { min-width: 80px; text-align: center; position: relative; cursor: pointer; }
        .u-card img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid transparent; transition: 0.3s; }
        .u-card.active img { border-color: var(--accent); }
        .u-card.has-chat::after { content: ''; position: absolute; top: 0; right: 10px; width: 12px; height: 12px; background: var(--accent); border-radius: 50%; border: 2px solid #111; }
        .like-badge { font-size: 10px; color: var(--primary); font-weight: bold; }

        /* ZONE CHAT (Masqu√©e par d√©faut) */
        #chat-section { flex: 1; display: none; flex-direction: column; background: #0f0f0f; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        /* BULLES */
        .msg { max-width: 70%; padding: 12px; border-radius: 15px; font-size: 14px; }
        .msg img { width: 100%; border-radius: 10px; display: block; }
        .me { align-self: flex-end; background: var(--primary); }
        .you { align-self: flex-start; background: #333; }

        /* ACTIONS BAR */
        .actions-bar { display: flex; justify-content: space-around; padding: 10px; background: #1a1a1a; border-top: 1px solid #222; }
        .btn { background: none; border: none; color: white; cursor: pointer; font-size: 20px; }

        /* VIDEO */
        #video-ui { display: none; position: fixed; inset: 0; background: #000; z-index: 4000; }
        #remote-v { width: 100%; height: 100%; object-fit: cover; }
        #local-v { position: absolute; top: 20px; right: 20px; width: 100px; height: 150px; border-radius: 10px; border: 2px solid var(--accent); object-fit: cover; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--primary)">BAN√ãA</h2>
            <input type="text" id="p-name" placeholder="Pseudo" style="width:100%; padding:12px; margin:10px 0; border-radius:10px; border:none; background:#222; color:white;">
            <select id="p-gender" style="width:100%; padding:12px; border-radius:10px; border:none; background:#222; color:white;">
                <option value="Homme">Homme</option>
                <option value="Femme">Femme</option>
            </select>
            <button onclick="startApp()" style="width:100%; padding:15px; margin-top:20px; border-radius:10px; border:none; background:var(--primary); color:white; font-weight:bold;">REJOINDRE</button>
        </div>
    </div>

    <div class="app-container" id="main-app">
        <div id="userList"></div>

        <div id="chat-section">
            <div class="actions-bar">
                <button class="btn" onclick="likeUser()">‚ù§Ô∏è</button>
                <button class="btn" onclick="initCall()">üìû Video</button>
                <button class="btn" style="color:red" onclick="blockUser()">üö´ Bloquer</button>
            </div>
            <div id="messages"></div>
            <div class="actions-bar">
                <button class="btn" onclick="document.getElementById('fileIn').click()">üì∑</button>
                <input type="file" id="fileIn" hidden onchange="uploadPhoto(this)">
                <input type="text" id="msgIn" placeholder="√âcrire..." style="flex:1; background:#222; border:none; padding:10px; border-radius:10px; color:white; margin:0 10px;">
                <button class="btn" onclick="sendText()">‚ûî</button>
            </div>
        </div>
    </div>

    <div id="video-ui">
        <video id="remote-v" autoplay playsinline></video>
        <video id="local-v" autoplay muted playsinline></video>
        <button onclick="endCall()" style="position:absolute; bottom:40px; left:50%; transform:translateX(-50%); background:red; border:none; width:70px; height:70px; border-radius:50%; font-size:30px;">üìµ</button>
    </div>

    <script>
        let socket, peer, myStream, targetSid, targetPid, myId;
        let chatLogs = {};

        function startApp() {
            const name = document.getElementById('p-name').value;
            if(!name) return;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';

            socket = io();
            peer = new Peer();

            peer.on('open', id => {
                myId = id;
                socket.emit('join-room', { username: name, gender: document.getElementById('p-gender').value, peerId: id });
            });

            socket.on('update-users', users => {
                const list = document.getElementById('userList');
                list.innerHTML = "";
                users.forEach(u => {
                    if(u.id !== socket.id) {
                        const card = document.createElement('div');
                        card.className = `u-card ${chatLogs[u.id] ? 'has-chat' : ''} ${targetSid === u.id ? 'active' : ''}`;
                        card.innerHTML = `<img src="${u.avatar}"><div class="like-badge">‚ù§Ô∏è ${u.likes}</div><div>${u.name}</div>`;
                        card.onclick = () => openDiscussion(u.id, u.peerId);
                        list.appendChild(card);
                    }
                });
            });

            socket.on('receive-private-message', data => {
                const partner = (data.fromId === socket.id) ? targetSid : data.fromId;
                if(!chatLogs[partner]) chatLogs[partner] = [];
                chatLogs[partner].push(data);
                if(partner === targetSid) renderChat();
                socket.emit('update-users-list'); // Refresh badges
            });

            socket.on('incoming-call', data => {
                if(confirm("Appel vid√©o entrant ?")) {
                    targetSid = data.fromId;
                    targetPid = data.fromPeerId;
                    answerCall();
                }
            });

            peer.on('call', call => {
                call.answer(myStream);
                call.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
            });
        }

        function openDiscussion(sid, pid) {
            targetSid = sid; targetPid = pid;
            document.getElementById('chat-section').style.display = 'flex';
            renderChat();
            // Refresh visuals
            socket.emit('update-users-list');
        }

        function renderChat() {
            const box = document.getElementById('messages');
            box.innerHTML = "";
            (chatLogs[targetSid] || []).forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.fromId === socket.id ? 'me' : 'you'}`;
                if(m.type === 'image') div.innerHTML = `<img src="${m.text}">`;
                else div.innerText = m.text;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        }

        function sendText() {
            const val = document.getElementById('msgIn').value;
            if(!val) return;
            socket.emit('send-private-message', { toSocketId: targetSid, text: val, type: 'text' });
            document.getElementById('msgIn').value = "";
        }

        function uploadPhoto(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = () => {
                socket.emit('send-private-message', { toSocketId: targetSid, text: reader.result, type: 'image' });
            };
            reader.readAsDataURL(file);
        }

        function likeUser() { socket.emit('send-like', targetSid); }

        function blockUser() {
            alert("Utilisateur bloqu√©.");
            document.getElementById('chat-section').style.display = 'none';
            targetSid = null;
        }

        async function initCall() {
            myStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('local-v').srcObject = myStream;
            document.getElementById('video-ui').style.display = 'block';
            socket.emit('propose-call', { toSocketId: targetSid, fromPeerId: myId });
            const call = peer.call(targetPid, myStream);
            call.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
        }

        async function answerCall() {
            myStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('local-v').srcObject = myStream;
            document.getElementById('video-ui').style.display = 'block';
        }

        function endCall() { location.reload(); }
    </script>
</body>
</html>
