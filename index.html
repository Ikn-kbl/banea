<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANÃ‹A LIVE</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #000; color: #00d2ff; font-family: sans-serif; text-align: center; margin: 0; padding: 10px; }
        .box { border: 2px solid #00d2ff; padding: 15px; border-radius: 10px; margin-top: 10px; }
        video { width: 45%; background: #222; border: 1px solid #00d2ff; border-radius: 10px; margin: 5px; height: 120px; object-fit: cover; }
        #chat { height: 180px; border: 1px solid #333; overflow-y: auto; background: #111; margin: 10px 0; padding: 10px; text-align: left; color: white; }
        input { padding: 12px; width: 60%; border-radius: 5px; border: none; font-size: 16px; }
        button { padding: 12px; background: #00d2ff; color: #000; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; }
        .user-row { display: flex; justify-content: space-between; background: #1a1a1a; padding: 10px; margin-top: 5px; border-radius: 5px; align-items: center; }
    </style>
</head>
<body>

    <h1 id="statut">BANÃ‹A LIVE</h1>

    <div id="login-screen" class="box">
        <input type="text" id="pseudoInput" placeholder="Ton pseudo...">
        <button onclick="demarrer()">ENTRER</button>
    </div>

    <div id="main-screen" style="display:none;">
        <div style="display:flex; justify-content: center;">
            <video id="localVid" autoplay muted playsinline></video>
            <video id="remoteVid" autoplay playsinline></video>
        </div>

        <div id="chat"></div>
        <div style="display:flex; gap:5px; justify-content: center;">
            <input type="text" id="msgInput" placeholder="Ton message...">
            <button onclick="envoyer()">ENVOYER</button>
        </div>

        <div id="userList" class="box">
            <p>Chargement des utilisateurs...</p>
        </div>
        
        <button onclick="location.reload()" style="background:red; color:white; margin-top:20px; width:100%;">QUITTER</button>
    </div>

    <script>
        let socket, peer, monStream, monNom;

        function demarrer() {
            monNom = document.getElementById('pseudoInput').value;
            if(!monNom) return alert("Choisis un pseudo !");

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'block';

            // Connexion au serveur
            socket = io();

            // Initialisation de la camÃ©ra
            navigator.mediaDevices.getUserMedia({video: true, audio: true})
                .then(stream => {
                    monStream = stream;
                    document.getElementById('localVid').srcObject = stream;
                })
                .catch(err => console.log("CamÃ©ra bloquÃ©e ou absente"));

            // Initialisation de la VidÃ©o (PeerJS)
            peer = new Peer();

            peer.on('open', (id) => {
                // On rejoint la salle une fois que tout est prÃªt
                socket.emit('join-room', { username: monNom, peerId: id });
                document.getElementById('statut').innerText = "âœ… EN DIRECT";
            });

            // Quand on reÃ§oit un message
            socket.on('receive-message', (data) => {
                const chat = document.getElementById('chat');
                chat.innerHTML += `<div><b style="color:#00d2ff">${data.user}:</b> ${data.text}</div>`;
                chat.scrollTop = chat.scrollHeight;
            });

            // Liste des gens connectÃ©s
            socket.on('update-users', (users) => {
                const list = document.getElementById('userList');
                list.innerHTML = "<b>Personnes en ligne :</b>";
                users.forEach(u => {
                    if(u.id !== socket.id) {
                        list.innerHTML += `
                            <div class="user-row">
                                <span>ðŸ‘¤ ${u.name}</span>
                                <button onclick="appeler('${u.peerId}')">APPELER VIDEO</button>
                            </div>`;
                    }
                });
            });

            // Recevoir un appel
            peer.on('call', (call) => {
                call.answer(monStream);
                call.on('stream', (remoteStream) => {
                    document.getElementById('remoteVid').srcObject = remoteStream;
                });
            });
        }

        function envoyer() {
            const msg = document.getElementById('msgInput').value;
            if(!msg) return;
            socket.emit('send-message', { user: monNom, text: msg });
            document.getElementById('msgInput').value = "";
        }

        function appeler(idDistant) {
            const call = peer.call(idDistant, monStream);
            call.on('stream', (remoteStream) => {
                document.getElementById('remoteVid').srcObject = remoteStream;
            });
        }
    </script>
</body>
</html>
