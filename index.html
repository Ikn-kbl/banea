<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BAN√ãA PURE</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #ff385c; --bg: #000; --card: #111; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* LOGIN */
        #login { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; align-items: center; justify-content: center; }
        .box { background: #111; padding: 30px; border-radius: 20px; text-align: center; width: 300px; border: 1px solid #333; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; background: #222; color: #fff; box-sizing: border-box; }
        
        /* LISTE PROFILS (OBJECTIF PRINCIPAL) */
        #userList { display: flex; gap: 15px; padding: 15px; overflow-x: auto; background: #000; border-bottom: 1px solid #222; }
        .u-card { min-width: 80px; text-align: center; cursor: pointer; position: relative; }
        .u-card img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid transparent; }
        .u-card.active img { border-color: var(--primary); }
        .u-card.has-chat::after { content: ''; position: absolute; top: 0; right: 10px; width: 12px; height: 12px; background: #00f2ff; border-radius: 50%; border: 2px solid #000; }
        .likes { font-size: 10px; color: var(--primary); }

        /* DISCUSSION (S'OUVRE SEULEMENT AU CLIC) */
        #chat-area { flex: 1; display: none; flex-direction: column; background: #080808; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 15px; font-size: 14px; line-height: 1.4; }
        .msg.me { align-self: flex-end; background: var(--primary); }
        .msg.you { align-self: flex-start; background: #222; }
        .msg img { width: 100%; border-radius: 10px; margin-top: 5px; }

        /* CONTROLES */
        .bar { display: flex; gap: 10px; padding: 12px; background: #111; align-items: center; }
        .btn { background: none; border: none; color: #fff; cursor: pointer; font-size: 20px; }
        
        /* VIDEO PLEIN ECRAN */
        #video-screen { display: none; position: fixed; inset: 0; background: #000; z-index: 50; }
        #remote-v { width: 100%; height: 100%; object-fit: cover; }
        #local-v { position: absolute; top: 20px; right: 20px; width: 100px; height: 140px; border-radius: 10px; border: 2px solid #fff; object-fit: cover; }
    </style>
</head>
<body>

    <div id="login">
        <div class="box">
            <h1 style="color:var(--primary); margin:0;">BAN√ãA</h1>
            <input type="text" id="nick" placeholder="Pseudo">
            <select id="gen"><option value="Homme">Homme</option><option value="Femme">Femme</option></select>
            <button onclick="enter()" style="width:100%; padding:15px; background:var(--primary); color:#fff; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ENTRER</button>
        </div>
    </div>

    <div id="userList"></div>

    <div id="chat-area">
        <div class="bar" style="border-bottom: 1px solid #222;">
            <button class="btn" onclick="like()">‚ù§Ô∏è</button>
            <button class="btn" onclick="call()">üìû Appel Video</button>
            <button class="btn" style="color:red; font-size:14px;" onclick="closeChat()">[Fermer]</button>
        </div>
        <div id="messages"></div>
        <div class="bar">
            <button class="btn" onclick="document.getElementById('imgIn').click()">üì∑</button>
            <input type="file" id="imgIn" hidden accept="image/*" onchange="sendImg(this)">
            <input type="text" id="msgIn" placeholder="Message..." style="flex:1; background:#222; border:none; padding:10px; border-radius:8px; color:#fff;">
            <button class="btn" onclick="sendTxt()">‚ûî</button>
        </div>
    </div>

    <div id="video-screen">
        <video id="remote-v" autoplay playsinline></video>
        <video id="local-v" autoplay muted playsinline></video>
        <button onclick="location.reload()" style="position:absolute; bottom:30px; left:50%; transform:translateX(-50%); background:red; border:none; width:60px; height:60px; border-radius:50%; color:#fff; font-size:25px;">üìµ</button>
    </div>

    <script>
        let socket, peer, myStream, targetSid, targetPid, myPeerId, chatLogs = {};

        function enter() {
            const n = document.getElementById('nick').value;
            if(!n) return;
            document.getElementById('login').style.display = 'none';
            socket = io();
            peer = new Peer();
            peer.on('open', id => {
                myPeerId = id;
                socket.emit('join-room', { username: n, gender: document.getElementById('gen').value, peerId: id });
            });

            socket.on('update-users', users => {
                const list = document.getElementById('userList');
                list.innerHTML = "";
                users.forEach(u => {
                    if(u.id !== socket.id) {
                        const div = document.createElement('div');
                        div.className = `u-card ${chatLogs[u.id] ? 'has-chat' : ''} ${targetSid === u.id ? 'active' : ''}`;
                        div.innerHTML = `<img src="${u.avatar}"><div class="likes">‚ù§Ô∏è ${u.likes}</div><div style="font-size:11px;">${u.name}</div>`;
                        div.onclick = () => openChat(u.id, u.peerId);
                        list.appendChild(div);
                    }
                });
            });

            socket.on('receive-private-message', data => {
                const partner = (data.fromId === socket.id) ? targetSid : data.fromId;
                if(!chatLogs[partner]) chatLogs[partner] = [];
                chatLogs[partner].push(data);
                if(partner === targetSid) render();
                socket.emit('update-users-list'); 
            });

            peer.on('call', async call => {
                if(confirm("Appel entrant. Accepter ?")) {
                    myStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                    document.getElementById('video-screen').style.display = 'block';
                    document.getElementById('local-v').srcObject = myStream;
                    call.answer(myStream);
                    call.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
                }
            });
        }

        function openChat(sid, pid) {
            targetSid = sid; targetPid = pid;
            document.getElementById('chat-area').style.display = 'flex';
            render();
        }

        function closeChat() {
            document.getElementById('chat-area').style.display = 'none';
            targetSid = null;
        }

        function render() {
            const box = document.getElementById('messages');
            box.innerHTML = "";
            (chatLogs[targetSid] || []).forEach(m => {
                const d = document.createElement('div');
                d.className = `msg ${m.fromId === socket.id ? 'me' : 'you'}`;
                d.innerHTML = m.type === 'image' ? `<img src="${m.text}">` : m.text;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        }

        function sendTxt() {
            const v = document.getElementById('msgIn').value;
            if(!v || !targetSid) return;
            socket.emit('send-private-message', { toSocketId: targetSid, text: v, type: 'text' });
            document.getElementById('msgIn').value = "";
        }

        function sendImg(input) {
            const reader = new FileReader();
            reader.onload = () => socket.emit('send-private-message', { toSocketId: targetSid, text: reader.result, type: 'image' });
            reader.readAsDataURL(input.files[0]);
        }

        function like() { socket.emit('send-like', targetSid); }

        async function call() {
            myStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('video-screen').style.display = 'block';
            document.getElementById('local-v').srcObject = myStream;
            const c = peer.call(targetPid, myStream);
            c.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
        }
    </script>
</body>
</html>
