<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BANÃ‹A PREMIUM</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #ff3b5c; --bg: #050505; --surface: #121214; --text: #f5f5f7; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; margin: 0; overflow: hidden; height: 100vh; }

        /* NOTIFICATION BANNER */
        #notif-banner { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(255,255,255,0.1); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 24px; z-index: 10000; display: flex; align-items: center; gap: 15px; transition: 0.6s cubic-bezier(0.2, 1, 0.2, 1); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        #notif-banner.active { top: 20px; }

        /* GRID LAYOUT */
        .main-content { height: 100vh; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .user-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; max-width: 1200px; margin: 0 auto; }
        .user-card { background: var(--surface); border-radius: 28px; overflow: hidden; position: relative; aspect-ratio: 0.8; border: 1px solid #222; cursor: pointer; transition: 0.4s; }
        .user-card:hover { transform: translateY(-8px); border-color: var(--accent); }
        .user-card img { width: 100%; height: 100%; object-fit: cover; }
        .card-overlay { position: absolute; bottom: 0; left: 0; right: 0; height: 50%; background: linear-gradient(transparent, rgba(0,0,0,0.9)); display: flex; align-items: flex-end; padding: 15px; }

        /* CHAT WINDOW SLIM & PRO */
        #chat-pane { position: fixed; inset: 0; background: var(--bg); z-index: 9000; display: none; flex-direction: column; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #chat-pane.active { display: flex; transform: translateY(0); }
        .chat-header { padding: 20px; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: space-between; background: rgba(10,10,11,0.8); backdrop-filter: blur(10px); }
        
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 75%; padding: 12px 18px; border-radius: 22px; font-size: 14px; line-height: 1.5; }
        .msg.me { align-self: flex-end; background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
        .msg.you { align-self: flex-start; background: #262629; border-bottom-left-radius: 4px; }

        .input-bar { padding: 15px 20px 35px; display: flex; gap: 10px; align-items: center; background: var(--bg); }
        .input-field { flex: 1; background: #1c1c1e; border: 1px solid #333; padding: 14px 20px; border-radius: 30px; color: #fff; outline: none; font-size: 15px; transition: 0.3s; }
        .input-field:focus { border-color: var(--accent); }
        .send-btn { background: var(--accent); border: none; width: 48px; height: 48px; border-radius: 50%; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }

        /* VIDEO CALL OVERLAY */
        #call-screen { display: none; position: fixed; inset: 0; background: #000; z-index: 10001; }
        #remote-v { width: 100%; height: 100%; object-fit: cover; }
        #local-v { position: absolute; top: 40px; right: 20px; width: 100px; height: 160px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.3); object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .call-tools { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }
        .tool-btn { width: 60px; height: 60px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; backdrop-filter: blur(10px); }
        .tool-hangup { background: #ff3b30; color: #fff; }
        .tool-alt { background: rgba(255,255,255,0.15); color: #fff; }

        /* LOGIN SCREEN */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .login-card { background: var(--surface); padding: 40px; border-radius: 35px; width: 100%; max-width: 340px; text-align: center; border: 1px solid #222; }
    </style>
</head>
<body>

    <div id="notif-banner">
        <div id="notif-avatar" style="width:45px; height:45px; background:var(--accent); border-radius:50%;"></div>
        <div style="flex:1">
            <div id="notif-name" style="font-weight:600; font-size:14px;">Nom</div>
            <div id="notif-text" style="font-size:13px; opacity:0.6;">Nouveau message</div>
        </div>
    </div>

    <div id="login-screen">
        <div class="login-card">
            <h1 style="color:var(--accent); margin:0 0 5px; font-size:32px;">BANÃ‹A</h1>
            <p style="opacity:0.4; font-size:13px; margin-bottom:30px;">ULTIMATE EDITION</p>
            <input type="text" id="in-name" class="input-field" style="width:100%; box-sizing:border-box; margin-bottom:12px;" placeholder="Ton PrÃ©nom">
            <input type="number" id="in-age" class="input-field" style="width:100%; box-sizing:border-box; margin-bottom:20px;" placeholder="Ton Ã‚ge">
            <button onclick="boot()" class="send-btn" style="width:100%; border-radius:15px; font-weight:600;">COMMENCER</button>
        </div>
    </div>

    <div class="main-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; max-width:1200px; margin: 0 auto 30px;">
            <h2 style="font-size:26px;">DÃ©couvrir</h2>
            <div style="width:10px; height:10px; background:#30d158; border-radius:50%; box-shadow: 0 0 10px #30d158;"></div>
        </div>
        <div id="userGrid" class="user-grid"></div>
    </div>

    <div id="chat-pane">
        <div class="chat-header">
            <button onclick="closeChat()" style="background:none; border:none; color:#fff; font-size:20px;">âœ•</button>
            <b id="target-name" style="font-size:17px;">Nom</b>
            <button onclick="startCall()" style="background:none; border:none; color:var(--accent); font-size:22px;">ðŸŽ¥</button>
        </div>
        <div id="messages"></div>
        <div class="input-bar">
            <input type="text" id="m-input" class="input-field" placeholder="Ã‰crire un message...">
            <button onclick="send()" class="send-btn">âž”</button>
        </div>
    </div>

    <div id="call-screen">
        <video id="remote-v" autoplay playsinline></video>
        <video id="local-v" autoplay muted playsinline></video>
        <div class="call-tools">
            <button class="tool-btn tool-alt" onclick="toggleMute()">ðŸŽ¤</button>
            <button class="tool-btn tool-hangup" onclick="endCall()">ðŸ“µ</button>
            <button class="tool-btn tool-alt" onclick="location.reload()">ðŸ”„</button>
        </div>
    </div>

    <script>
        let socket, peer, localStream, currentCall, targetSid, targetPid, logs = {};

        function boot() {
            const n = document.getElementById('in-name').value;
            const a = document.getElementById('in-age').value;
            if(!n || !a) return;
            document.getElementById('login-screen').style.display = 'none';
            socket = io();
            peer = new Peer();

            peer.on('open', id => {
                socket.emit('join-room', { username: n, age: a, peerId: id });
            });

            socket.on('update-users', users => {
                const grid = document.getElementById('userGrid');
                grid.innerHTML = "";
                users.forEach(u => {
                    if(u.id !== socket.id) {
                        const card = document.createElement('div');
                        card.className = "user-card";
                        card.onclick = () => openChat(u.id, u.peerId, u.name);
                        card.innerHTML = `<img src="${u.avatar}"><div class="card-overlay"><b>${u.name}, ${u.age}</b></div>`;
                        grid.appendChild(card);
                    }
                });
            });

            socket.on('receive-private-message', data => {
                const partner = (data.fromId === socket.id) ? targetSid : data.fromId;
                if(!logs[partner]) logs[partner] = [];
                logs[partner].push(data);
                if(partner === targetSid) render();
                else flashNotif(data);
            });

            peer.on('call', async call => {
                if(confirm("Appel de " + call.peer + " ?")) {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: { aspectRatio: 9/16 },
                        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                    });
                    document.getElementById('call-screen').style.display = 'block';
                    document.getElementById('local-v').srcObject = localStream;
                    call.answer(localStream);
                    currentCall = call;
                    call.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
                }
            });
        }

        function flashNotif(data) {
            const b = document.getElementById('notif-banner');
            document.getElementById('notif-name').innerText = data.sender;
            document.getElementById('notif-text').innerText = data.text;
            b.classList.add('active');
            setTimeout(() => b.classList.remove('active'), 4000);
        }

        function openChat(sid, pid, name) {
            targetSid = sid; targetPid = pid;
            document.getElementById('target-name').innerText = name;
            const pane = document.getElementById('chat-pane');
            pane.style.display = 'flex';
            setTimeout(() => pane.classList.add('active'), 10);
            render();
        }

        function closeChat() {
            const pane = document.getElementById('chat-pane');
            pane.classList.remove('active');
            setTimeout(() => pane.style.display = 'none', 400);
        }

        function render() {
            const box = document.getElementById('messages');
            box.innerHTML = "";
            (logs[targetSid] || []).forEach(m => {
                const d = document.createElement('div');
                d.className = `msg ${m.fromId === socket.id ? 'me' : 'you'}`;
                d.innerText = m.text;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        }

        function send() {
            const i = document.getElementById('m-input');
            if(!i.value) return;
            socket.emit('send-private-message', { toSocketId: targetSid, text: i.value });
            i.value = "";
        }

        async function startCall() {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: { aspectRatio: 9/16 },
                audio: { echoCancellation: true, noiseSuppression: true }
            });
            document.getElementById('call-screen').style.display = 'block';
            document.getElementById('local-v').srcObject = localStream;
            currentCall = peer.call(targetPid, localStream);
            currentCall.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
        }

        function endCall() {
            if(currentCall) currentCall.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('call-screen').style.display = 'none';
        }
    </script>
</body>
</html>
